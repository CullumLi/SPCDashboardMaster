Option Explicit

' 全域變數：用於統計數量
Dim countTotal As Long ' M
Dim countPeak As Long  ' N
Dim countShift As Long ' O
Dim countTilt As Long  ' P

Sub Run_SPC_Full_Project_Forced()
    Dim t As Double
    t = Timer
    
    ' 1. 環境設定
    ' 強制版仍需關閉螢幕更新以提速
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.DisplayAlerts = False
    
    ' 初始化計數器
    countTotal = 0: countPeak = 0: countShift = 0: countTilt = 0
    
    ' 2. 執行 Step 1: 資料拆分
    Application.StatusBar = "【Step 1】正在執行資料拆分..."
    Call Step1_Split_Data
    
    ' 3. 執行 Step 2: SPC 篩選
    Application.StatusBar = "【Step 2】正在執行 SPC 運算與篩選..."
    Call Step2_SPC_Filter
    
    ' 4. 執行 Step 3: 繪圖與歸納
    Application.StatusBar = "【Step 3】正在繪製圖表與歸納..."
    Call Step3_Chart_And_Report
    
    ' 5. 恢復環境 & 報告
    Application.StatusBar = False
    Application.DisplayAlerts = True
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    
    MsgBox "異常Trend Chart製圖與篩選歸納已完成，" & vbCrLf & _
           "本次分析Chart ID總數量: " & countTotal & "個 ," & vbCrLf & _
           "Peak數量: " & countPeak & "個 ," & vbCrLf & _
           "Shift數量: " & countShift & "個," & vbCrLf & _
           "Tilt數量: " & countTilt & "個" & vbCrLf & vbCrLf & _
           "總耗時: " & Format(Timer - t, "0.00") & "秒", vbInformation
End Sub

' ==========================================
' Step 1: 強制拆分與欄位對應
' ==========================================
Sub Step1_Split_Data()
    Dim wb As Workbook
    Dim wsSource As Worksheet
    Dim rng As Range, dict As Object, cell As Range
    Dim lastRow As Long
    Dim key As Variant
    Dim newWs As Worksheet
    Dim visRng As Range
    
    Set wb = ThisWorkbook
    
    ' [檢查] 來源分頁
    On Error Resume Next
    Set wsSource = wb.Sheets("1_1")
    On Error GoTo 0
    
    If wsSource Is Nothing Then
        MsgBox "嚴重錯誤：找不到名稱為 [1_1] 的分頁！程式終止。", vbCritical
        End
    End If
    
    ' [強制] 解除篩選
    If wsSource.FilterMode Then wsSource.ShowAllData
    
    ' [檢查] 資料量
    lastRow = wsSource.Cells(wsSource.Rows.Count, "B").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "嚴重錯誤：B 欄 (Chart ID) 無資料！(LastRow < 2)", vbCritical
        End
    End If
    
    ' [建立清單]
    Set rng = wsSource.Range("B2:B" & lastRow)
    Set dict = CreateObject("Scripting.Dictionary")
    
    For Each cell In rng
        If Not IsError(cell.Value) Then
            If Len(Trim(CStr(cell.Value))) > 0 Then
                dict(CStr(cell.Value)) = 1
            End If
        End If
    Next cell
    
    If dict.Count = 0 Then
        MsgBox "嚴重錯誤：B 欄找不到任何有效的 ID！", vbCritical
        End
    End If
    
    ' [迴圈] 拆分
    For Each key In dict.keys
        Application.StatusBar = "正在拆分 ID: " & key
        
        ' 刪除舊分頁
        On Error Resume Next
        wb.Sheets(CStr(key)).Delete
        On Error GoTo 0
        
        Set newWs = wb.Sheets.Add(After:=wb.Sheets(wb.Sheets.Count))
        newWs.Name = CStr(key)
        
        ' 篩選
        wsSource.Range("A1").AutoFilter Field:=2, Criteria1:=key
        
        ' [關鍵] 欄位 Mapping
        ' 來源: B, C, H, I, Y, AA, AB, AC, AD, AE, AF, AG
        ' 目標: A, B, C, D, E, F,  G,  H,  I,  J,  K,  L
        
        On Error Resume Next
        Set visRng = wsSource.Range("A1:AG" & lastRow).SpecialCells(xlCellTypeVisible)
        On Error GoTo 0
        
        If Not visRng Is Nothing Then
            Intersect(visRng, wsSource.Columns("B")).Copy newWs.Range("A1")  ' ID
            Intersect(visRng, wsSource.Columns("C")).Copy newWs.Range("B1")  ' Name
            Intersect(visRng, wsSource.Columns("H")).Copy newWs.Range("C1")  ' DATA_VALUE (C欄)
            Intersect(visRng, wsSource.Columns("I")).Copy newWs.Range("D1")  ' UPDATE_TIME (D欄)
            Intersect(visRng, wsSource.Columns("Y")).Copy newWs.Range("E1")
            Intersect(visRng, wsSource.Columns("AA")).Copy newWs.Range("F1") ' XBAR (F欄)
            Intersect(visRng, wsSource.Columns("AB")).Copy newWs.Range("G1") ' SIGMA (G欄)
            Intersect(visRng, wsSource.Columns("AC")).Copy newWs.Range("H1") ' SPEC_HIGH (H欄)
            Intersect(visRng, wsSource.Columns("AD")).Copy newWs.Range("I1") ' SPEC_LOW (I欄)
            Intersect(visRng, wsSource.Columns("AE")).Copy newWs.Range("J1") ' SPEC_TARGET (J欄)
            Intersect(visRng, wsSource.Columns("AF")).Copy newWs.Range("K1") ' UCL (K欄)
            Intersect(visRng, wsSource.Columns("AG")).Copy newWs.Range("L1") ' LCL (L欄)
            
            newWs.Columns("A:L").AutoFit
        End If
    Next key
    
    ' [清理]
    wsSource.AutoFilterMode = False
    Application.DisplayAlerts = False
    wsSource.Delete
    
    ' 建立結果頁
    Dim sName As Variant
    For Each sName In Array("Tilt", "Shift", "Peak")
        On Error Resume Next
        wb.Sheets(sName).Delete
        On Error GoTo 0
        Set newWs = wb.Sheets.Add(Before:=wb.Sheets(1))
        newWs.Name = sName
        newWs.Tab.Color = vbRed
    Next sName
    Application.DisplayAlerts = True
End Sub

' ==========================================
' Step 2: SPC 篩選 (刪除非紅色的分頁)
' ==========================================
Sub Step2_SPC_Filter()
    Dim ws As Worksheet
    Dim arr As Variant
    Dim i As Long, r As Long
    Dim isAnomaly As Boolean
    Dim val As Double, sigma As Double, target As Double
    Dim cShift As Long, cTrendUp As Long, cTrendDown As Long
    Dim lastVal As Double
    Dim wsToDelete As Collection
    
    Set wsToDelete = New Collection
    
    For Each ws In ThisWorkbook.Worksheets
        ' 跳過保留頁
        If ws.Name = "Peak" Or ws.Name = "Shift" Or ws.Name = "Tilt" Then GoTo NextWs
        
        r = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
        If r < 2 Then GoTo MarkForDelete
        
        ' 讀取 A~J 欄 (Data=C:3, Sigma=G:7, Target=J:10)
        arr = ws.Range("A2:J" & r).Value
        
        isAnomaly = False
        cShift = 0: cTrendUp = 0: cTrendDown = 0
        
        For i = 1 To UBound(arr, 1)
            ' 驗證
            If Not IsNumeric(arr(i, 3)) Or Not IsNumeric(arr(i, 7)) Or Not IsNumeric(arr(i, 10)) Then GoTo ContinueLoop
            If IsEmpty(arr(i, 3)) Then GoTo ContinueLoop
            
            val = CDbl(arr(i, 3))
            sigma = CDbl(arr(i, 7))
            target = CDbl(arr(i, 10))
            If sigma = 0 Then sigma = 0.00001
            
            Dim absDiff As Double
            absDiff = Abs(val - target)
            
            ' Rule A
            If absDiff > 2 * sigma Then
                isAnomaly = True
                Exit For
            End If
            
            ' Rule B
            If absDiff > 1.5 * sigma Then cShift = cShift + 1 Else cShift = 0
            If cShift >= 3 Then
                isAnomaly = True
                Exit For
            End If
            
            ' Rule C
            If i > 1 Then
                If val > lastVal Then
                    cTrendUp = cTrendUp + 1: cTrendDown = 0
                ElseIf val < lastVal Then
                    cTrendDown = cTrendDown + 1: cTrendUp = 0
                Else
                    cTrendUp = 0: cTrendDown = 0
                End If
            End If
            If cTrendUp >= 6 Or cTrendDown >= 6 Then
                isAnomaly = True
                Exit For
            End If
            
            lastVal = val
ContinueLoop:
        Next i
        
        If isAnomaly Then
            ws.Tab.Color = vbRed
        Else
MarkForDelete:
            wsToDelete.Add ws
        End If
NextWs:
    Next ws
    
    ' 批次刪除
    Application.DisplayAlerts = False
    Dim item As Worksheet
    For Each item In wsToDelete
        If item.Name <> "Peak" And item.Name <> "Shift" And item.Name <> "Tilt" Then
            If ThisWorkbook.Worksheets.Count > 3 Then item.Delete
        End If
    Next item
    Application.DisplayAlerts = True
End Sub

' ==========================================
' Step 3: 繪圖與歸納
' ==========================================
Sub Step3_Chart_And_Report()
    Dim ws As Worksheet
    Dim wsPeak As Worksheet, wsShift As Worksheet, wsTilt As Worksheet
    Dim wb As Workbook
    Dim lastRow As Long
    
    Set wb = ThisWorkbook
    Set wsPeak = wb.Sheets("Peak")
    Set wsShift = wb.Sheets("Shift")
    Set wsTilt = wb.Sheets("Tilt")
    
    Dim topPeak As Double, topShift As Double, topTilt As Double
    topPeak = 10: topShift = 10: topTilt = 10
    
    For Each ws In wb.Worksheets
        ' 只處理紅色分頁 (且非結果頁)
        If ws.Tab.Color = vbRed And ws.Name <> "Peak" And ws.Name <> "Shift" And ws.Name <> "Tilt" Then
            
            Application.StatusBar = "正在繪圖: " & ws.Name
            countTotal = countTotal + 1
            
            lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
            If lastRow < 2 Then GoTo NextSheet
            
            ' 1. [排序] 依照 D欄 (UPDATE_TIME) 由遠到近
            ws.Range("A1:L" & lastRow).Sort Key1:=ws.Range("D1"), Order1:=xlAscending, Header:=xlYes
            
            ' 2. [分析異常點] 寫入 Col M (Peak), Col N (Shift), Col O (Tilt)
            ' 為了分開標記紅點，我們將三種異常存入不同欄位 (M=Peak, N=Shift, O=Tilt)
            ' 但題目需求是：只要異常就紅點放大，並分類歸檔。
            ' 為簡化，我們將所有異常統一寫入 M 欄，但在歸檔複製時判斷分類。
            
            Dim arr As Variant, arrErr() As Variant
            arr = ws.Range("A2:L" & lastRow).Value 
            ReDim arrErr(1 To UBound(arr, 1), 1 To 1)
            
            Dim hasPeak As Boolean, hasShift As Boolean, hasTilt As Boolean
            hasPeak = False: hasShift = False: hasTilt = False
            
            Dim val As Double, sigma As Double, target As Double
            Dim cShift As Long, cTrendUp As Long, cTrendDown As Long
            Dim lastVal As Double
            Dim i As Long
            
            cShift = 0: cTrendUp = 0: cTrendDown = 0: lastVal = 0
            
            For i = 1 To UBound(arr, 1)
                Dim isPointBad As Boolean
                isPointBad = False
                
                If IsNumeric(arr(i, 3)) And IsNumeric(arr(i, 7)) And IsNumeric(arr(i, 10)) And Not IsEmpty(arr(i, 3)) Then
                    val = CDbl(arr(i, 3))
                    sigma = CDbl(arr(i, 7))
                    target = CDbl(arr(i, 10))
                    If sigma = 0 Then sigma = 0.00001
                    
                    Dim absDiff As Double
                    absDiff = Abs(val - target)
                    
                    ' Rule A (Peak)
                    If absDiff > 2 * sigma Then
                        isPointBad = True: hasPeak = True
                    End If
                    
                    ' Rule B (Shift)
                    If absDiff > 1.5 * sigma Then cShift = cShift + 1 Else cShift = 0
                    If cShift >= 3 Then
                        isPointBad = True: hasShift = True
                    End If
                    
                    ' Rule C (Tilt)
                    If i > 1 Then
                        If val > lastVal Then
                            cTrendUp = cTrendUp + 1: cTrendDown = 0
                        ElseIf val < lastVal Then
                            cTrendDown = cTrendDown + 1: cTrendUp = 0
                        Else
                            cTrendUp = 0: cTrendDown = 0
                        End If
                    End If
                    If cTrendUp >= 6 Or cTrendDown >= 6 Then
                        isPointBad = True: hasTilt = True
                    End If
                    
                    lastVal = val
                    
                    If isPointBad Then arrErr(i, 1) = val Else arrErr(i, 1) = CVErr(xlErrNA)
                Else
                    arrErr(i, 1) = CVErr(xlErrNA)
                End If
            Next i
            
            ws.Range("M2").Resize(UBound(arrErr, 1), 1).Value = arrErr
            
            ' 3. [繪圖]
            Dim chObj As ChartObject
            Dim ch As Chart
            ' 高 17.5cm ~= 496pt, 寬 37.5cm ~= 1063pt
            Set chObj = ws.ChartObjects.Add(Left:=10, Top:=10, Width:=1063, Height:=496)
            Set ch = chObj.Chart
            ch.ChartType = xlXYScatterLines
            
            ' 主數據 (C vs D)
            With ch.SeriesCollection.NewSeries
                .Name = "Data"
                .XValues = ws.Range("D2:D" & lastRow)
                .Values = ws.Range("C2:C" & lastRow)
                .Format.Line.ForeColor.RGB = RGB(0, 0, 255)
                .MarkerStyle = xlMarkerStyleNone
            End With
            
            ' 異常紅點 (M vs D) - 放大顯示
            With ch.SeriesCollection.NewSeries
                .Name = "Anomaly"
                .XValues = ws.Range("D2:D" & lastRow)
                .Values = ws.Range("M2:M" & lastRow)
                .MarkerStyle = xlMarkerStyleCircle
                .MarkerSize = 8  ' 放大紅點
                .MarkerBackgroundColor = RGB(255, 0, 0)
                .MarkerForegroundColor = RGB(255, 0, 0)
                .Format.Line.Visible = msoFalse
            End With
            
            ' 輔助線 (Target, High, Low, UCL, LCL)
            Call AddLineSeries(ch, ws, "Target", "J", lastRow, RGB(0, 0, 0))    ' Black
            Call AddLineSeries(ch, ws, "Spec High", "H", lastRow, RGB(255, 0, 0)) ' Red
            Call AddLineSeries(ch, ws, "Spec Low", "I", lastRow, RGB(255, 0, 0))  ' Red
            Call AddLineSeries(ch, ws, "UCL", "K", lastRow, RGB(0, 176, 80))    ' Green
            Call AddLineSeries(ch, ws, "LCL", "L", lastRow, RGB(0, 176, 80))    ' Green
            
            ' 格式設定
            ch.HasTitle = True
            ch.ChartTitle.Text = ws.Range("A2").Value & " " & ws.Range("B2").Value
            
            ' X軸設定 (只顯示日期)
            With ch.Axes(xlCategory)
                .TickLabels.Orientation = xlTickLabelOrientationVertical
                .TickLabelPosition = xlTickLabelPositionLow
                .CategoryType = xlCategoryScale ' 確保日期軸
                .TickLabels.NumberFormat = "yyyy/mm/dd" ' 不顯示時間
                .MajorUnit = 7 ' 約每週顯示一次標籤 (1cm間距需視解析度，這裡設合理間隔)
            End With
            
            ' Y軸設定 (Min=I, Max=H)
            On Error Resume Next
            Dim yMin As Double, yMax As Double
            If IsNumeric(ws.Range("I2").Value) Then yMin = ws.Range("I2").Value Else yMin = 0
            If IsNumeric(ws.Range("H2").Value) Then yMax = ws.Range("H2").Value Else yMax = 100
            With ch.Axes(xlValue)
                .MinimumScale = yMin
                .MaximumScale = yMax
                .TickLabels.NumberFormat = "General"
            End With
            On Error GoTo 0
            
            ' 4. [複製歸納]
            If hasPeak Then
                Call CopyChartToResult(chObj, wsPeak, topPeak)
                countPeak = countPeak + 1
            End If
            If hasShift Then
                Call CopyChartToResult(chObj, wsShift, topShift)
                countShift = countShift + 1
            End If
            If hasTilt Then
                Call CopyChartToResult(chObj, wsTilt, topTilt)
                countTilt = countTilt + 1
            End If
            
            ' 刪除暫存圖表與 M 欄
            chObj.Delete
            ws.Range("M2:M" & lastRow).ClearContents
            
        End If
NextSheet:
    Next ws
End Sub

' 輔助：繪製虛線
Sub AddLineSeries(ch As Chart, ws As Worksheet, sName As String, col As String, lRow As Long, color As Long)
    If Application.CountA(ws.Range(col & "2:" & col & lRow)) > 0 Then
        With ch.SeriesCollection.NewSeries
            .Name = sName
            .XValues = ws.Range("D2:D" & lRow)
            .Values = ws.Range(col & "2:" & col & lRow)
            .Format.Line.ForeColor.RGB = color
            .Format.Line.Weight = 2.5
            .Format.Line.DashStyle = msoLineDash
            .MarkerStyle = xlMarkerStyleNone
        End With
    End If
End Sub

' 輔助：複製圖表到結果頁
Sub CopyChartToResult(srcObj As ChartObject, targetWs As Worksheet, ByRef topPos As Double)
    Dim newObj As ChartObject
    srcObj.Chart.ChartArea.Copy
    targetWs.Paste
    Set newObj = targetWs.ChartObjects(targetWs.ChartObjects.Count)
    newObj.Left = 10
    newObj.Top = topPos
    topPos = topPos + newObj.Height + 20 ' 增加間距
End Sub
