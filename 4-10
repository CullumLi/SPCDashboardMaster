Option Explicit

'=============================================================================
' VBA Master SPC Macro - Full Automation (Fixed Version)
' Author: Gemini (VBA Master)
' Description: SPC Calculation, Anomaly Detection, Charting & Summary
'=============================================================================

Sub MasterSPC_Executor()
    Dim wb As Workbook
    Dim FilePicker As FileDialog
    Dim FilePath As String
    Dim StartTime As Double
    Dim M As Long, N As Long, O As Long, P As Long
    
    '--- 0. 檔案選擇 ---
    Set FilePicker = Application.FileDialog(msoFileDialogFilePicker)
    With FilePicker
        .Title = "VBA大師: 請選擇欲分析的 Excel 檔案"
        .Filters.Add "Excel Files", "*.xlsx; *.xlsm; *.xlsb", 1
        .AllowMultiSelect = False
        If .Show = -1 Then
            FilePath = .SelectedItems(1)
        Else
            MsgBox "未選擇檔案，程式終止。", vbExclamation
            Exit Sub
        End If
    End With
    
    StartTime = Timer
    
    '--- 優化效能與環境設定 (修正處) ---
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False ' <--- 已修正此處 (原錯誤: EventMacroEnabled)
    
    ' 開啟檔案
    Set wb = Workbooks.Open(FilePath)
    
    ' 加入錯誤處理，確保發生錯誤時能恢復 Excel 設定
    On Error GoTo ErrorHandler
    
    '--- 執行三大步驟 ---
    Call Step1_SplitData(wb, M)
    Call Step2_SPC_Calculation(wb)
    Call Step3_Chart_Summary(wb, N, O, P)
    
    '--- 恢復設定與報告 ---
ExitHandler:
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True ' <--- 已修正此處
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    
    Dim SecondsElapsed As Double
    SecondsElapsed = Round(Timer - StartTime, 2)
    
    MsgBox "異常Trend Chart製圖與篩選歸納已完成" & vbCrLf & _
           "執行秒數: " & SecondsElapsed & " 秒" & vbCrLf & _
           "本次分析Chart ID總數量(M): " & M & " 個" & vbCrLf & _
           "Peak數量(N): " & N & " 個" & vbCrLf & _
           "Shift數量(O): " & O & " 個" & vbCrLf & _
           "Tilt數量(P): " & P & " 個", vbInformation, "VBA Master SPC Report"
    Exit Sub

ErrorHandler:
    MsgBox "執行過程中發生錯誤: " & Err.Description, vbCritical
    Resume ExitHandler
           
End Sub

'=============================================================================
' Step 1: 資料拆分與欄位重組
'=============================================================================
Sub Step1_SplitData(wb As Workbook, ByRef TotalIDs As Long)
    Dim wsSource As Worksheet
    Dim wsNew As Worksheet
    Dim Dict As Object, Key As Variant
    Dim LastRow As Long
    Dim SummarySheets As Variant, S As Variant
    
    On Error Resume Next
    Set wsSource = wb.Sheets("1_1")
    On Error GoTo 0
    
    If wsSource Is Nothing Then
        MsgBox "錯誤: 找不到 '1_1' 分頁。", vbCritical
        End ' 強制終止
    End If
    
    ' 新增 Summary Sheets
    SummarySheets = Array("Peak", "Shift", "Tilt")
    For Each S In SummarySheets
        On Error Resume Next
        wb.Sheets(S).Delete
        On Error GoTo 0
        Set wsNew = wb.Sheets.Add(After:=wb.Sheets(wb.Sheets.Count))
        wsNew.Name = S
    Next S
    
    wsSource.Activate
    LastRow = wsSource.Cells(wsSource.Rows.Count, "B").End(xlUp).Row
    Set Dict = CreateObject("Scripting.Dictionary")
    
    Dim Cell As Range
    ' 取得唯一 Chart ID (B欄)
    For Each Cell In wsSource.Range("B2:B" & LastRow)
        If Not IsError(Cell.Value) Then
            If Cell.Value <> "" And Not Dict.Exists(Cell.Value) Then
                Dict.Add Cell.Value, Nothing
            End If
        End If
    Next Cell
    
    TotalIDs = Dict.Count
    
    ' 拆分資料
    For Each Key In Dict.Keys
        ' 篩選 ID
        wsSource.Range("A1").AutoFilter Field:=2, Criteria1:=Key
        
        ' 新增分頁
        Set wsNew = wb.Sheets.Add(After:=wb.Sheets(wb.Sheets.Count))
        ' 處理檔名特殊字元與長度限制
        Dim SheetName As String
        SheetName = Left(CStr(Key), 30)
        SheetName = Replace(SheetName, ":", "")
        SheetName = Replace(SheetName, "/", "")
        On Error Resume Next
        wsNew.Name = SheetName
        On Error GoTo 0
        
        ' 複製並重組欄位
        Dim VisibleRng As Range
        On Error Resume Next
        Set VisibleRng = wsSource.Range("A2:AG" & LastRow).SpecialCells(xlCellTypeVisible)
        On Error GoTo 0
        
        If Not VisibleRng Is Nothing Then
            ' 寫入標題
            wsNew.Range("A1:L1").Value = Array("CHART_ID", "CHART_NAME", "DATA_VALUE", "UPDATE_TIME", _
                                               "Y_COL", "XBAR", "SIGMA", "SPEC_HIGH", "SPEC_LOW", _
                                               "SPEC_TARGET", "UCL", "LCL")
            
            ' 複製各欄 (使用 Intersect 確保只複製可見儲存格)
            Intersect(VisibleRng, wsSource.Columns("B")).Copy wsNew.Range("A2")
            Intersect(VisibleRng, wsSource.Columns("I")).Copy wsNew.Range("B2")
            Intersect(VisibleRng, wsSource.Columns("C")).Copy wsNew.Range("C2")
            Intersect(VisibleRng, wsSource.Columns("H")).Copy wsNew.Range("D2")
            Intersect(VisibleRng, wsSource.Columns("Y")).Copy wsNew.Range("E2")
            Intersect(VisibleRng, wsSource.Columns("AA")).Copy wsNew.Range("F2")
            Intersect(VisibleRng, wsSource.Columns("AB")).Copy wsNew.Range("G2")
            Intersect(VisibleRng, wsSource.Columns("AC")).Copy wsNew.Range("H2")
            Intersect(VisibleRng, wsSource.Columns("AD")).Copy wsNew.Range("I2")
            Intersect(VisibleRng, wsSource.Columns("AE")).Copy wsNew.Range("J2")
            Intersect(VisibleRng, wsSource.Columns("AF")).Copy wsNew.Range("K2")
            Intersect(VisibleRng, wsSource.Columns("AG")).Copy wsNew.Range("L2")
            
            wsNew.Columns("A:L").AutoFit
        End If
    Next Key
    
    wsSource.AutoFilterMode = False
    Application.DisplayAlerts = False
    wsSource.Delete
    Application.DisplayAlerts = True
End Sub

'=============================================================================
' Step 2: SPC 異常計算與篩選
'=============================================================================
Sub Step2_SPC_Calculation(wb As Workbook)
    Dim ws As Worksheet
    Dim LastRow As Long, i As Long, k As Long
    Dim ValData As Double, Tgt As Double, Sig As Double
    Dim IsPeak As Boolean, IsShift As Boolean, IsTilt As Boolean
    Dim HasAnomaly As Boolean
    Dim DelList As New Collection
    Dim Item As Variant
    
    ' 顏色常數
    ' Orange RGB(255, 165, 0)
    ' Red vbRed
    ' Purple RGB(200, 0, 200)
    
    For Each ws In wb.Worksheets
        If ws.Name <> "Peak" And ws.Name <> "Shift" And ws.Name <> "Tilt" Then
            
            LastRow = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row
            If LastRow < 2 Then GoTo NextSheet
            
            ' 確保按時間排序 (Update Time 在 D 欄)
            ws.Range("A1").CurrentRegion.Sort Key1:=ws.Range("D1"), Order1:=xlAscending, Header:=xlYes
            
            HasAnomaly = False
            
            ' 為了效能，將數據讀入陣列
            Dim ArrData As Variant
            ' 讀取 A 到 L (1 to 12)
            ArrData = ws.Range("A1:L" & LastRow).Value
            
            Dim RngPeak As Range, RngShift As Range, RngTilt As Range
            
            For i = 2 To LastRow
                ValData = Val(ArrData(i, 3)) ' C欄: DATA_VALUE
                Sig = Val(ArrData(i, 7))     ' G欄: SIGMA
                Tgt = Val(ArrData(i, 10))    ' J欄: SPEC_TARGET
                
                ' 異常 A: Peak (|Val - Tgt| > 2*Sigma)
                ' 需求: > +2Sigma 或 < -2Sigma (即絕對值 > 2*Sigma)
                IsPeak = False
                If Abs(ValData - Tgt) > (2 * Sig) Then
                    IsPeak = True
                    If RngPeak Is Nothing Then Set RngPeak = ws.Cells(i, 3) Else Set RngPeak = Union(RngPeak, ws.Cells(i, 3))
                End If
                
                ' 異常 B: Shift (連續3點 > 1.5*Sigma 或 < -1.5*Sigma)
                ' 即連續三點的 (Val-Tgt) 同正且 > 1.5Sig，或同負且 < -1.5Sig
                ' 但需求文字為 "連續3點( DATA_VALUE - SPEC_TARGET ) > +1.5*SIGMA 或 ... < -1.5*SIGMA"
                ' 這意味著必須是「連續三個正」或「連續三個負」。絕對值判斷可能會誤判一正一負的情況。
                ' 因此這裡嚴格判斷方向。
                
                If i <= LastRow - 2 Then
                    Dim Diff1 As Double, Diff2 As Double, Diff3 As Double
                    Dim S1 As Double, S2 As Double, S3 As Double
                    
                    Diff1 = Val(ArrData(i, 3)) - Val(ArrData(i, 10))
                    Diff2 = Val(ArrData(i + 1, 3)) - Val(ArrData(i + 1, 10))
                    Diff3 = Val(ArrData(i + 2, 3)) - Val(ArrData(i + 2, 10))
                    
                    S1 = Val(ArrData(i, 7))
                    S2 = Val(ArrData(i + 1, 7))
                    S3 = Val(ArrData(i + 2, 7))
                    
                    Dim IsShiftPos As Boolean, IsShiftNeg As Boolean
                    IsShiftPos = (Diff1 > 1.5 * S1) And (Diff2 > 1.5 * S2) And (Diff3 > 1.5 * S3)
                    IsShiftNeg = (Diff1 < -1.5 * S1) And (Diff2 < -1.5 * S2) And (Diff3 < -1.5 * S3)
                    
                    If IsShiftPos Or IsShiftNeg Then
                        Dim RngTemp As Range
                        Set RngTemp = ws.Range(ws.Cells(i, 3), ws.Cells(i + 2, 3))
                        If RngShift Is Nothing Then Set RngShift = RngTemp Else Set RngShift = Union(RngShift, RngTemp)
                    End If
                End If
                
                ' 異常 C: Tilt (連續7點 變大 or 連續7點 變小)
                If i <= LastRow - 6 Then
                    Dim IncCount As Integer, DecCount As Integer
                    IncCount = 0: DecCount = 0
                    For k = 0 To 5
                        ' 下一點 > 當前點
                        If Val(ArrData(i + k + 1, 3)) > Val(ArrData(i + k, 3)) Then IncCount = IncCount + 1
                        ' 下一點 < 當前點
                        If Val(ArrData(i + k + 1, 3)) < Val(ArrData(i + k, 3)) Then DecCount = DecCount + 1
                    Next k
                    
                    ' 6次比較都成立 = 7點連續
                    If IncCount = 6 Or DecCount = 6 Then
                        Dim RngTemp2 As Range
                        Set RngTemp2 = ws.Range(ws.Cells(i, 3), ws.Cells(i + 6, 3))
                        If RngTilt Is Nothing Then Set RngTilt = RngTemp2 Else Set RngTilt = Union(RngTilt, RngTemp2)
                    End If
                End If
            Next i
            
            ' 批量上色
            If Not RngPeak Is Nothing Then
                RngPeak.Interior.Color = RGB(255, 165, 0)
                HasAnomaly = True
            End If
            If Not RngShift Is Nothing Then
                RngShift.Interior.Color = vbRed
                HasAnomaly = True
            End If
            If Not RngTilt Is Nothing Then
                RngTilt.Interior.Color = RGB(200, 0, 200)
                HasAnomaly = True
            End If
            
            ' 標記分頁
            If HasAnomaly Then
                ws.Tab.Color = vbRed
            Else
                DelList.Add ws
            End If
            
        End If
NextSheet:
    Next ws
    
    ' 刪除無異常分頁
    For Each Item In DelList
        Item.Delete
    Next Item
End Sub

'=============================================================================
' Step 3: 繪圖與歸納
'=============================================================================
Sub Step3_Chart_Summary(wb As Workbook, ByRef N As Long, ByRef O As Long, ByRef P As Long)
    Dim ws As Worksheet
    Dim ChObj As ChartObject
    Dim Ch As Chart
    Dim LastRow As Long
    Dim RngX As Range, RngY As Range
    Dim SpecHigh As Double, SpecLow As Double
    Dim TitleStr As String
    Dim PosTop(1 To 3) As Double ' 1:Peak, 2:Shift, 3:Tilt
    Dim i As Integer
    
    ' 初始化位置
    For i = 1 To 3
        PosTop(i) = 10
    Next i
    
    ' 圖表尺寸
    Const ChHeight As Double = 450
    Const ChWidth As Double = 990
    
    N = 0: O = 0: P = 0
    
    For Each ws In wb.Worksheets
        If ws.Tab.Color = vbRed And ws.Visible = xlSheetVisible Then
            
            LastRow = ws.Cells(ws.Rows.Count, "D").End(xlUp).Row
            ' Step 3-1: 再次確保排序
            ws.Range("A1").CurrentRegion.Sort Key1:=ws.Range("D1"), Order1:=xlAscending, Header:=xlYes
            
            ' 取得範圍
            Set RngX = ws.Range("D2:D" & LastRow)
            Set RngY = ws.Range("C2:C" & LastRow)
            
            ' 取得Y軸範圍
            SpecLow = Application.WorksheetFunction.Min(ws.Range("I2:I" & LastRow))
            SpecHigh = Application.WorksheetFunction.Max(ws.Range("H2:H" & LastRow))
            
            TitleStr = ws.Cells(2, 1).Value & " " & ws.Cells(2, 2).Value
            
            ' 建立圖表
            Set ChObj = ws.ChartObjects.Add(Left:=10, Top:=50, Width:=ChWidth, Height:=ChHeight)
            Set Ch = ChObj.Chart
            Ch.ChartType = xlXYScatterLines
            
            ' --- 數據數列 ---
            Do While Ch.SeriesCollection.Count > 0: Ch.SeriesCollection(1).Delete: Loop
            
            With Ch.SeriesCollection.NewSeries
                .Name = "Data"
                .XValues = RngX
                .Values = RngY
                .Format.Line.ForeColor.RGB = RGB(0, 0, 255) ' Blue
                .MarkerStyle = xlMarkerStyleCircle
                .MarkerSize = 5
            End With
            
            ' --- 輔助線 ---
            Call AddLimitLine(Ch, RngX, ws.Range("J2:J" & LastRow), RGB(0, 0, 0))   ' Target
            Call AddLimitLine(Ch, RngX, ws.Range("H2:H" & LastRow), RGB(255, 0, 0)) ' High
            Call AddLimitLine(Ch, RngX, ws.Range("I2:I" & LastRow), RGB(255, 0, 0)) ' Low
            Call AddLimitLine(Ch, RngX, ws.Range("K2:K" & LastRow), RGB(0, 128, 0)) ' UCL
            Call AddLimitLine(Ch, RngX, ws.Range("L2:L" & LastRow), RGB(0, 128, 0)) ' LCL
            
            ' --- 格式設定 ---
            Ch.HasTitle = True
            Ch.ChartTitle.Text = TitleStr
            
            With Ch.Axes(xlCategory)
                .TickLabels.NumberFormat = "yyyy/mm/dd"
                .TickLabels.Orientation = xlTickLabelOrientationVertical
                .MajorUnit = 0.1
                .MinorUnit = 0.02
                .HasTitle = True
                .AxisTitle.Text = "UPDATE_TIME"
            End With
            
            With Ch.Axes(xlValue)
                .MinimumScale = SpecLow
                .MaximumScale = SpecHigh
                .HasTitle = True
                .AxisTitle.Text = "DATA_VALUE"
            End With
            
            ' --- 異常點標記 ---
            Dim Pts As Points
            Dim Pt As Point
            Dim PtIdx As Long
            Dim CellColor As Long
            Dim IsSheetPeak As Boolean, IsSheetShift As Boolean, IsSheetTilt As Boolean
            
            IsSheetPeak = False: IsSheetShift = False: IsSheetTilt = False
            
            Set Pts = Ch.SeriesCollection(1).Points
            For PtIdx = 1 To Pts.Count
                CellColor = ws.Cells(PtIdx + 1, 3).Interior.Color
                Set Pt = Pts(PtIdx)
                
                If CellColor = RGB(255, 165, 0) Then
                    FormatAnomalyPoint Pt, RGB(255, 165, 0)
                    IsSheetPeak = True
                ElseIf CellColor = vbRed Then
                    FormatAnomalyPoint Pt, vbRed
                    IsSheetShift = True
                ElseIf CellColor = RGB(200, 0, 200) Then
                    FormatAnomalyPoint Pt, RGB(200, 0, 200)
                    IsSheetTilt = True
                End If
            Next PtIdx
            
            ' --- 複製到歸納分頁 ---
            If IsSheetPeak Then
                N = N + 1
                CopyChartToSheet ChObj, wb.Sheets("Peak"), PosTop(1)
            End If
            
            If IsSheetShift Then
                O = O + 1
                CopyChartToSheet ChObj, wb.Sheets("Shift"), PosTop(2)
            End If
            
            If IsSheetTilt Then
                P = P + 1
                CopyChartToSheet ChObj, wb.Sheets("Tilt"), PosTop(3)
            End If
        End If
    Next ws
End Sub

Sub AddLimitLine(Ch As Chart, XRng As Range, YRng As Range, ColorRGB As Long)
    With Ch.SeriesCollection.NewSeries
        .XValues = XRng
        .Values = YRng
        .ChartType = xlXYScatterLines
        .MarkerStyle = xlMarkerStyleNone
        .Format.Line.ForeColor.RGB = ColorRGB
        .Format.Line.DashStyle = msoLineDash
        .Format.Line.Weight = 2.5
    End With
End Sub

Sub FormatAnomalyPoint(Pt As Point, ColorRGB As Long)
    With Pt
        .MarkerStyle = xlMarkerStyleCircle
        .MarkerBackgroundColor = ColorRGB
        .MarkerForegroundColor = ColorRGB
        .MarkerSize = 10
    End With
End Sub

Sub CopyChartToSheet(SourceObj As ChartObject, TargetWs As Worksheet, ByRef CurrentTop As Double)
    ' 使用 Copy 複製容器，然後 Paste
    SourceObj.Copy
    TargetWs.Paste
    
    ' 貼上後，該物件會成為 Selection (或是最後一個圖表)
    ' 為了保險，我們抓取該頁面最後一個 ChartObject
    Dim NewChObj As ChartObject
    Set NewChObj = TargetWs.ChartObjects(TargetWs.ChartObjects.Count)
    
    NewChObj.Top = CurrentTop
    NewChObj.Left = 10
    
    CurrentTop = CurrentTop + NewChObj.Height + 20
End Sub
